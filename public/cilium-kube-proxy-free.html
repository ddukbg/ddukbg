<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kube-proxy 없이 살아가기: Cilium을 활용한 성능 최적화와 구성 가이드 - </title>
  <style>
    body {
      background-color: #008080; /* Teal */
      color: black;
      font-family: 'Tahoma', 'MS Sans Serif', sans-serif; /* Original Windows 98 fonts */ /* Windows 98 fonts only */
      font-size: 11px;
      margin: 0;
      padding: 0;
      /* NOTE: On mobile, 'overflow:hidden' prevents scrolling and breaks layout. */
      overflow-x: hidden;
      overflow-y: auto;
    }
    .win98-container {
      padding: 15px;
    }
    .win98-window {
      background-color: #c0c0c0; /* Silver */
      border-top: 2px solid #ffffff;
      border-left: 2px solid #ffffff;
      border-right: 2px solid #808080; /* Gray */
      border-bottom: 2px solid #808080;
      box-shadow: 1px 1px 0 #000000;
      display: flex;
      flex-direction: column;
      min-width: 300px;
      max-width: 800px; /* Desktop-friendly limit */
      width: calc(100vw - 30px);
      margin: 0 auto; /* Center */
    }
    .win98-titlebar {
      background: linear-gradient(to right, #000080, #1084d0); /* Navy to Blue gradient */
      color: white;
      padding: 3px 5px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
      height: 18px;
    }
    .win98-titlebar-text::before {
      content: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA8AAAAPCAYAAAA71pVKAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAACGSURBVDhPY/z//z8DNwMDw8zAALyZgUE4//+hMMEAglgGJxAPkNwAEieAmAMRL679vxjAxH8gNvz/MFAMgokBAZgIA5j8/zAIFwQDX//8/yHz//8HY+A/FFp+//9/ZkDB//+D+B+I/P//f2KAwv+//w/E/0Hk////HxQCYOKDAgMDAwMArcUqD+3hWzQAAAAASUVORK5CYII='); /* Tiny icon */
      margin-right: 5px;
      vertical-align: middle;
    }
    .win98-controls button {
      background-color: #c0c0c0;
      border-top: 1px solid #ffffff;
      border-left: 1px solid #ffffff;
      border-right: 1px solid #808080;
      border-bottom: 1px solid #808080;
      width: 16px;
      height: 14px;
      font-family: 'Tahoma', 'MS Sans Serif', sans-serif; /* Original Windows 98 fonts */
      font-size: 10px;
      padding: 0;
      margin-left: 2px;
      line-height: 12px;
      text-align: center;
      cursor: default;
    }
    
    /* Explorer style layout */
    .explorer-layout {
      display: flex;
      flex-direction: column;
      max-height: calc(100vh - 150px); /* Set a max height to leave room for statusbar */
    }
    
    .explorer-header {
      display: flex;
      align-items: center;
      padding: 5px;
      border-bottom: 1px solid #808080;
    }
    
    .explorer-header-text {
      margin-left: 5px;
      font-weight: bold;
    }
    
    .explorer-body {
      display: flex;
      flex: 1;
      border: 1px solid #808080;
      margin: 3px;
      background-color: white;
      position: relative; /* Add relative positioning */
    }
    
    .explorer-sidebar {
      width: 180px;
      background-color: #c0c0c0;
      border-right: 2px solid #808080;
      overflow-y: auto;
      padding: 5px;
    }
    
    .explorer-sidebar-title {
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .explorer-sidebar-item {
      display: flex;
      align-items: center;
      margin: 3px 0;
      cursor: pointer;
      padding: 2px 4px;
    }
    
    .explorer-sidebar-item:hover {
      background-color: #000080; /* Navy blue */
      color: white;
    }
    
    .explorer-sidebar-item:active {
      background-color: #0000AA; /* Darker blue */
      color: white;
    }
    
    .explorer-sidebar-item::before {
      content: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAMCAYAAABWdVznAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAABRSURBVDhPY1hZWfEfA57///9/gJqGhoa/AxMDFQDEyMioAJE/MDAwMP7/n1iAIAMAwSIEEMUyQDgIKAZgRUMjIUMDAwMDw+Q/Q9wAEgAArHIHqcGD3XAAAAAASUVORK5CYII='); /* Folder icon */
      margin-right: 5px;
    }
    
    .explorer-content {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      padding-bottom: 60px; /* Add significant padding at bottom */
      max-height: calc(100vh - 180px);
    }
    
    /* Markdown content styling */
    .explorer-content h1, .explorer-content h2, .explorer-content h3 {
      margin-top: 1em;
      margin-bottom: 0.5em;
      font-weight: bold;
      font-family: 'Tahoma', 'MS Sans Serif', sans-serif; /* Original Windows 98 fonts */
    }
    .explorer-content h1 { font-size: 14px; }
    .explorer-content h2 { font-size: 13px; }
    .explorer-content h3 { font-size: 12px; }
    .explorer-content p { margin: 0.5em 0; line-height: 1.4; }
    .explorer-content ul, .explorer-content ol {
      padding-left: 20px;
      margin: 0.5em 0;
    }
    .explorer-content li {
      margin-bottom: 3px;
    }
    .explorer-content img {
      max-width: 100%;
      border: 1px solid #808080;
    }
    .explorer-content code {
      font-family: 'Tahoma', 'MS Sans Serif', sans-serif; /* Original Windows 98 fonts */
      background-color: #e0e0e0; /* Slightly different gray */
      padding: 0.1em 0.3em;
      border: 1px solid #b0b0b0;
      font-size: 0.95em;
    }
    .explorer-content pre {
      font-family: 'Tahoma', 'MS Sans Serif', sans-serif; /* Original Windows 98 fonts */
      background-color: #ffffff; /* White background like notepad */
      border: 1px solid #808080; /* Simple gray border */
      padding: 10px;
      margin: 1em 0;
      overflow-x: auto;
      white-space: pre;
      font-size: 1em; /* Reset pre font size */
    }
    .explorer-content pre code {
      background-color: transparent;
      border: none;
      padding: 0;
    }
    .explorer-content blockquote {
      border: 1px solid #808080;
      border-left: 5px solid #000080; /* Navy blue left border */
      padding: 10px 15px;
      margin: 1em 0;
      color: #333;
      background-color: #f8f8f8;
    }
    .explorer-content hr {
      border: none;
      border-top: 1px solid #808080; /* Gray top */
      border-bottom: 1px solid #ffffff; /* White bottom */
      height: 2px;
      margin: 1em 0;
    }
    
    .explorer-content table {
      border-collapse: collapse;
      width: 100%;
      margin: 1em 0;
    }
    
    .explorer-content th, .explorer-content td {
      border: 1px solid #808080;
      padding: 4px 8px;
    }
    
    .explorer-content th {
      background-color: #d0d0d0;
      font-weight: bold;
    }
    
    /* Links like Windows 98 */
    .explorer-content a {
      color: #0000ff;
      text-decoration: underline;
      display: inline-block; /* Allow margin to be applied */
      margin-bottom: 5px; /* Add space below links */
    }
    
    /* Add specific styling for navigation links at bottom of page */
    .explorer-content a[href="/"], .explorer-content a:contains("Home"), .explorer-content a:contains("Back") {
      margin-bottom: 30px; /* Extra margin for navigation links */
    }
    
    .explorer-content a:visited {
      color: #800080;
    }
    
    .explorer-content a:hover {
      color: #ff0000;
    }
    
    .win98-statusbar {
      background-color: #c0c0c0;
      border-top: 1px solid #808080;
      border-left: 1px solid #808080;
      border-right: 1px solid #ffffff;
      border-bottom: 1px solid #ffffff;
      padding: 2px 5px;
      height: 18px;
      display: flex;
    }
    .win98-statusbar-panel {
      border-top: 1px solid #808080;
      border-left: 1px solid #808080;
      border-right: 1px solid #ffffff;
      border-bottom: 1px solid #ffffff;
      padding: 0 5px;
      margin-right: 2px;
      flex-grow: 1;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis; /* Add ellipsis for text overflow */
      max-width: 100%; /* Ensure content stays within container */
    }
    /* Windows 98 Button Style */
    .win98-button {
      display: inline-block;
      background-color: #c0c0c0;
      color: #000;
      border-top: 1px solid #ffffff;
      border-left: 1px solid #ffffff;
      border-right: 1px solid #808080;
      border-bottom: 1px solid #808080;
      padding: 3px 8px;
      margin: 2px;
      text-decoration: none;
      font-size: 11px;
      cursor: pointer;
      box-shadow: 1px 1px 0 #000000;
    }
    .win98-button:hover {
      background-color: #d0d0d0;
    }
    .win98-button:active {
      background-color: #b0b0b0;
      border-top: 1px solid #808080;
      border-left: 1px solid #808080;
      border-right: 1px solid #ffffff;
      border-bottom: 1px solid #ffffff;
      box-shadow: none;
    }

    /* Mobile / small screens */
    @media (max-width: 640px) {
      body {
        font-size: 12px;
      }
      .win98-container {
        padding: 10px;
      }
      .win98-window {
        width: calc(100vw - 20px);
        max-width: none;
        min-width: 0;
      }
      .explorer-layout {
        max-height: none;
      }
      .explorer-body {
        flex-direction: column;
      }
      .explorer-sidebar {
        width: auto;
        border-right: none;
        border-bottom: 2px solid #808080;
      }
    }
  
    /* StyleMD watermark */
    .stylemd-watermark {
      position: fixed;
      right: 10px;
      bottom: 10px;
      font-size: 10px;
      opacity: 0.5;
      color: #777;
      z-index: 100;
      pointer-events: none;
    }
    .stylemd-watermark a {
      color: inherit;
      text-decoration: none;
    }
  </style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js/styles/default.min.css"><script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script><script>mermaid.initialize({ startOnLoad: true, securityLevel: "loose" });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script><script>MathJax = { tex: { inlineMath: [["$", "$"]], displayMath: [["$", "$"]] } };</script></head>
<body>
  <div class="win98-container">
    <div class="win98-window">
      <div class="win98-titlebar">
        <span class="win98-titlebar-text">My Document</span>
        <div class="win98-controls">
          <button title="Minimize">_</button>
          <button title="Maximize">&#9633;</button>
          <button title="Close">X</button>
        </div>
      </div>
      
      <div class="explorer-layout">
        <div class="explorer-header">
          <span class="explorer-header-text">My Blog</span>
        </div>
        
        <div class="explorer-body">
          <div class="explorer-sidebar">
            <div class="explorer-sidebar-title">Directories</div>
            <div class="explorer-sidebar-item">pages</div>
            <div class="explorer-sidebar-item">content</div>
          </div>
          
          <div class="explorer-content">
            <header>
    <h1>Kube-proxy 없이 살아가기: Cilium을 활용한 성능 최적화와 구성 가이드</h1>
    <p><small>Thu Aug 14 2025 09:00:00 GMT+0900 (Korean Standard Time) 9:00 AM</small></p>
    <nav class="nav-links">
      <a href="index.html" class="win98-button">Home</a>
        <a href="about.html" class="win98-button">About</a>
    </nav>
  </header>
    <h1 id="kube-proxy-cilium-"><a href="#kube-proxy-cilium-" class="header-anchor"></a>Kube-proxy 없이 살아가기: Cilium을 활용한 성능 최적화</h1><p>Kubernetes 클러스터를 운영하다 보면 필연적으로 <strong>네트워킹 성능</strong>과 <strong>확장성</strong> 문제에 부딪히게 됩니다. 그 중심에는 늘 <code>kube-proxy</code>가 있습니다. 기본적으로 제공되는 컴포넌트지만, 서비스 개수가 늘어날수록 <code>iptables</code> 규칙이 기하급수적으로 증가하며 성능 저하를 유발하죠.</p>
<p>이번 글에서는 <strong>Kube-proxy를 완전히 제거하고</strong>, eBPF 기반의 <strong>Cilium</strong>으로 이를 대체하는 방법(Kube-proxy Replacement)과, 왜 그렇게 해야 하는지 <strong>성능 관점</strong>에서 깊이 있게 다뤄보겠습니다.</p>
<hr>
<h2 id="1-kube-proxy-iptables-"><a href="#1-kube-proxy-iptables-" class="header-anchor"></a>1. Kube-proxy의 한계 (iptables의 고통)</h2><p>Kube-proxy의 기본 모드인 <code>iptables</code> 모드는 리눅스 커널의 패킷 필터링 기능을 사용하여 서비스(ClusterIP) 트래픽을 백엔드 파드로 로드밸런싱합니다.</p>
<h3 id="o-n-"><a href="#o-n-" class="header-anchor"></a>O(N)의 복잡도</h3><p>문제는 <code>iptables</code> 규칙이 리스트 형태(Sequential List)로 처리된다는 점입니다. 서비스 하나를 찾기 위해 수천, 수만 개의 규칙을 순차적으로 평가해야 할 수도 있습니다.</p>
<ul>
<li>서비스 5,000개 생성 시: 라우팅 규칙 업데이트에 수 분 소요</li>
<li>패킷 처리량(Throughput) 저하 및 CPU 사용량 급증</li>
</ul>
<p><code>IPVS</code> 모드가 대안으로 나왔지만, 여전히 연결 추적(Conntrack) 테이블 고갈 문제나 복잡한 관리 포인트가 남습니다.</p>
<hr>
<h2 id="2-cilium-ebpf-"><a href="#2-cilium-ebpf-" class="header-anchor"></a>2. Cilium과 eBPF: 게임 체인저</h2><p>Cilium은 리눅스 커널의 <strong>eBPF(Extended Berkeley Packet Filter)</strong> 기술을 활용합니다. 네트워크 패킷을 커널 레벨에서 샌드박싱된 프로그램으로 처리하죠.</p>
<h3 id="ebpf-"><a href="#ebpf-" class="header-anchor"></a>eBPF의 장점</h3><ol>
<li><strong>O(1) 해시 테이블</strong>: iptables의 순차 검색 대신, eBPF Map(해시 테이블)을 사용하여 어떤 규모에서도 <strong>일정한(Constant)</strong> 룩업 성능을 보장합니다.</li>
<li><strong>Context Switching 감소</strong>: 사용자 공간(User Space)과 커널 공간(Kernel Space) 사이의 불필요한 전환 없이 패킷을 즉시 처리합니다.</li>
<li><strong>Kube-proxy 불필요</strong>: Cilium이 Service IP 해석, 로드밸런싱, NAT를 모두 직접 수행합니다.</li>
</ol>
<hr>
<h2 id="3-kube-proxy-free-"><a href="#3-kube-proxy-free-" class="header-anchor"></a>3. Kube-proxy Free 모드 구성하기</h2><p>이제 실제로 Kube-proxy를 걷어내고 Cilium만으로 클러스터를 구성해 봅시다.</p>
<h3 id="--60"><a href="#--60" class="header-anchor"></a>전제 조건</h3><ul>
<li>EKS, GKE, 또는 베어메탈 클러스터 생성 시 <code>kube-proxy</code>를 애초에 설치하지 않거나, 설치 후 비활성화해야 합니다.</li>
<li>(EKS의 경우) AWS VPC CNI와 체이닝하거나, Cilium을 전용 CNI로 쓸 수 있습니다.</li>
</ul>
<h3 id="helm-"><a href="#helm-" class="header-anchor"></a>Helm 설정 (핵심)</h3><p>Cilium 설치 시 <code>kubeProxyReplacement</code> 값을 <code>true</code>로 설정하는 것이 핵심입니다.</p>
<pre><code class="hljs bash">helm install cilium cilium/cilium \
  --namespace kube-system \
  --<span class="hljs-built_in">set</span> kubeProxyReplacement=<span class="hljs-literal">true</span> \
  --<span class="hljs-built_in">set</span> k8sServiceHost=API_SERVER_IP \
  --<span class="hljs-built_in">set</span> k8sServicePort=API_SERVER_PORT \
  <span class="hljs-comment"># 필요 시 추가 설정</span>
  --<span class="hljs-built_in">set</span> socketLB.enabled=<span class="hljs-literal">true</span> \
  --<span class="hljs-built_in">set</span> bpf.masquerade=<span class="hljs-literal">true</span></code></pre><h3 id="--61"><a href="#--61" class="header-anchor"></a>주요 파라미터 설명</h3><ul>
<li><strong><code>kubeProxyReplacement=true</code></strong>: Cilium이 kube-proxy 역할을 대신합니다.</li>
<li><strong><code>socketLB.enabled=true</code></strong>: 소켓 레벨 로드밸런싱을 활성화하여 사이드카 프록시를 거치지 않고도 파드 통신을 최적화합니다.</li>
<li><strong><code>bpf.masquerade=true</code></strong>: iptables 대신 eBPF 기반의 고성능 Masquerading(NAT)을 사용합니다.</li>
</ul>
<hr>
<h2 id="4-"><a href="#4-" class="header-anchor"></a>4. 성능 차이 심층 분석</h2><p>실제 벤치마크 결과(서비스 10,000개 기준)를 비교해보면 그 차이는 명확합니다.</p>
<h3 id="latency-"><a href="#latency-" class="header-anchor"></a>Latency (지연 시간)</h3><ul>
<li><strong>Kube-proxy (iptables)</strong>: 서비스 개수가 늘어날수록 Latency가 선형적으로 증가합니다. 특정 구간에서는 핑이 튀는 현상(Jitter)이 발생합니다.</li>
<li><strong>Cilium (eBPF)</strong>: 서비스가 100개든 10,000개든 Latency가 <strong>거의 일정하게 유지</strong>됩니다.</li>
</ul>
<h3 id="cpu-overhead"><a href="#cpu-overhead" class="header-anchor"></a>CPU Overhead</h3><ul>
<li><strong>Kube-proxy</strong>: 룰 업데이트 시마다 커널 락(Lock)을 걸고 iptables 전체를 리로드하는 경우가 많아 CPU 스파이크가 발생합니다.</li>
<li><strong>Cilium</strong>: eBPF Map의 증분 업데이트(Incremental Update)만 수행하므로 CPU 부하가 매우 낮습니다.</li>
</ul>
<h3 id="throughput-"><a href="#throughput-" class="header-anchor"></a>Throughput (처리량)</h3><p>eBPF 기반의 XDP(eXpress Data Path)까지 활용하면, 네트워크 카드로 들어온 패킷을 OS 네트워크 스택을 거치지 않고 바로 처리할 수 있어, iptables 대비 <strong>최대 5~6배</strong> 이상의 처리량을 보여주기도 합니다.</p>
<hr>
<h2 id="5-"><a href="#5-" class="header-anchor"></a>5. 결론</h2><p>대규모 클러스터나 마이크로서비스 아키텍처(MSA) 환경에서 <strong>Kube-proxy Free (Cilium)</strong> 모드는 선택이 아닌 필수 전락하고 있습니다.</p>
<p>단순히 &quot;빠르다&quot;는 것을 넘어, <strong>운영의 복잡성을 줄이고 예측 가능한 성능</strong>을 보장한다는 점에서 강력히 추천합니다. 지금 바로 여러분의 클러스터에서 레거시 iptables를 걷어내 보세요.</p>
<blockquote>
<p><strong>Note</strong>: 기존 클러스터에서 마이그레이션할 경우, 다운타임이 발생할 수 있으므로 신중한 계획이 필요합니다.</p>
</blockquote>
<hr>

            <div style="height: 50px;"></div>
          </div>
        </div>
      </div>
      
      <div class="win98-statusbar">
        <div class="win98-statusbar-panel" style="text-overflow: ellipsis; white-space: nowrap; overflow: hidden;">Ready</div>
      </div>
    </div>
  </div>
  <div class="stylemd-watermark">Made with <a href="https://github.com/ddukbg/stylemd">StyleMD</a></div>
</body>
</html> 